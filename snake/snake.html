<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>贪吃蛇</title>
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/normalize/3.0.3/normalize.min.css">
    <style type="text/css">
        #map {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 600px;
            height: 600px;
            margin-top: -300px;
            margin-left: -300px;
            background: #999;
            overflow: hidden;
        }
        #control {
            position: absolute;
            left: 200px;
            top: 200px;
        }
        button {
            color: #fff;
            background: #999;
        }
    </style>
</head>
<body>
    <div id="control">
        <button id="start"/>开始游戏</button>
        <span>得分：</span><span id="score"></span>
    </div>
    <div id="map" ></div>
    <script type="text/javascript">
        (function() {
            var map = document.getElementById('map');
            // 贪吃蛇的身体
            var snakeBody = [];
            // 初始移动方向
            var stepX = 20;
            var stepY = 0;
            var moveDir = 'right';
            // 控制移动定时器
            var timer;

            // 初始化蛇身
            function initSnake(num) {
                var snakeNode = document.createElement('div');
                snakeNode.style.position = 'absolute';
                snakeNode.style.top = '0px';
                snakeNode.style.left =  num * 20+'px';
                snakeNode.style.background = '#383838';
                snakeNode.style.width = '20px';
                snakeNode.style.height = '20px';
                snakeBody.push(snakeNode);
                map.appendChild(snakeNode);
            }

            // 让蛇移动
            function snakeMove() {
                // 前一个部分位置等于上一个部分
                for(var i = snakeBody.length - 1; i > 0; i--) {
                    snakeBody[i].style.left = snakeBody[i-1].style.left;
                    snakeBody[i].style.top = snakeBody[i-1].style.top;
                }
                // 设置蛇头前进位置
                snakeBody[0].style.left = parseInt(snakeBody[0].style.left) + stepX +'px';
                snakeBody[0].style.top = parseInt(snakeBody[0].style.top) + stepY +'px';
                // 不断前行
                timer = setTimeout(snakeMove, 400);
            }

            // 重置运动
            function reMove() {
                clearTimeout(timer);
                snakeMove()
            }

            // 控制方向
            function dirControl(ev) {
                var oEvent = ev || event;
                var n = oEvent.keyCode;
                switch(n) {
                    case 37:
                        // 向相反方向运动时按键无效
                        if (moveDir === 'right') {
                            break;
                        } else {
                            stepX = -20;
                            stepY = 0;
                            moveDir = 'left';
                        }
                        reMove();
                    break;
                    case 38:
                        if (moveDir === 'down') {
                            break;
                        } else {
                            stepX = 0;
                            stepY = -20;
                            moveDir = 'up';
                        }
                        reMove();
                    break;
                    case 39:
                        if ( moveDir === 'left') {
                            break;
                        } else {
                            stepX = 20;
                            stepY = 0;
                            moveDir = 'right';
                        }
                        reMove();
                    break;
                    case 40:
                        if (moveDir === 'up') {
                            break;
                        } else {
                            stepX = 0;
                            stepY = 20;
                            moveDir = 'down';
                        }
                        reMove();
                    break;
                }
            }

            // 判断是否死亡
            function touchBound() {
                // 计算得分
                var score = document.getElementById('score');
                score.innerHTML = (snakeBody.length-3);
                // 获取蛇头位置
                var x1 = parseInt(snakeBody[0].style.left);
                var y1 = parseInt(snakeBody[0].style.top);
                // 判断是否碰到墙壁
                if (x1<0 || x1>580 || y1<0 || y1>580) {
                    alert('Game Over');
                    window.location.reload();
                }
                // 判断是否碰到自己
                if (snakeBody.length > 4) {
                    for (var i = 3; i < snakeBody.length - 1; i++) {
                        var x2 = parseInt(snakeBody[i].style.left);
                        var y2 = parseInt(snakeBody[i].style.top);
                        if (x1 === x2 && y1 === y2) {
                            alert('Game Over');
                            window.location.reload();
                        }
                    }
                }
                setTimeout(touchBound, 30);
            }

            // 生成食物
            function generateFood() {
                var foodX = Math.floor(Math.random() * 29) * 20 + 'px';
                var foodY = Math.floor(Math.random() * 29) * 20 + 'px';
                var foodDiv = document.createElement('div');
                // 设置食物位置
                foodDiv.style.position = 'absolute';
                foodDiv.style.top = foodY;
                foodDiv.style.left = foodX;
                foodDiv.style.width = '20px';
                foodDiv.style.height = '20px';
                foodDiv.style.backgroundColor = '#fff';
                // 给食物做标记
                foodDiv.id = 'food';
                map.appendChild(foodDiv);
            }

            // 吃掉食物
            function eat() {
                // 得到蛇头坐标
                var x1 = parseInt(snakeBody[0].style.left);
                var y1 = parseInt(snakeBody[0].style.top);
                // 得到食物坐标
                var food = document.getElementById('food');
                var x2 = parseInt(food.style.left);
                var y2 = parseInt(food.style.top);
                if (Math.abs(x1 - x2) < 20 && Math.abs(y1 - y2) < 20) {
                    food.style.backgroundColor = '#383838';
                    snakeBody.push(food);
                    food.id = '';
                    // 生成食物
                    generateFood();
                }
                setTimeout(eat, 30);
            }

            // 监听方向键
            document.onkeydown = dirControl;
            // 点击按钮初始化游戏
            document.getElementById('start').onclick = function() {
                if (this.innerHTML === '重新开始') {
                    // 重置
                    map.innerHTML = '';
                    snakeBody = [];
                    stepX = 20;
                    stepY = 0;
                    moveDir = 'right';
                    clearTimeout(timer);
                }
                for (var i = 2; i >= 0; i--) {
                    initSnake(i);
                }
                snakeMove();
                touchBound();
                generateFood();
                eat();
                // 按钮点击一次后失效
                this.innerHTML= '重新开始';
            }
        })();
    </script>
</body>
</html>